WITH mismatches AS (
  SELECT
    src.registered_entity_id,
    src.effective_dt,

    -- apply same NVL defaults as your audit
    NVL(src.public_registered_entity_id,  -1) AS src_pub_reg_ent,
    NVL(tgt.public_registered_entity_id,  -1) AS tgt_pub_reg_ent,
    NVL(src.public_issuer_bus_ent_id,     -1) AS src_pub_bus_ent,
    NVL(tgt.public_issuer_bus_ent_id,     -1) AS tgt_pub_bus_ent,
    NVL(src.public_issuer_bus_ent_type_cd,'NA') AS src_bus_type,
    NVL(tgt.public_issuer_bus_ent_type_cd,'NA') AS tgt_bus_type,
    NVL(src.public_issuer_bus_ent_short_desc,'NA') AS src_short_desc,
    NVL(tgt.public_issuer_bus_ent_short_desc,'NA') AS tgt_short_desc,
    NVL(src.public_issuer_bus_ent_long_desc,'NA')  AS src_long_desc,
    NVL(tgt.public_issuer_bus_ent_long_desc,'NA')  AS tgt_long_desc,
    NVL(src.public_issuer_bus_ent_fmr_id,   'NA') AS src_fmr_id,
    NVL(tgt.public_issuer_bus_ent_fmr_id,   'NA') AS tgt_fmr_id,
    NVL(src.public_issuer_cusip,            'NA') AS src_cusip,
    NVL(tgt.public_issuer_cusip,            'NA') AS tgt_cusip,
    NVL(src.public_equity_cusip,            'NA') AS src_equity_cusip,
    NVL(tgt.public_equity_cusip,            'NA') AS tgt_equity_cusip,
    NVL(src.public_equity_isin,             'NA') AS src_equity_isin,
    NVL(tgt.public_equity_isin,             'NA') AS tgt_equity_isin

  FROM PUBLIC_ATTR_TRNS_SRH_ALTID_QDATA_ALT src
  JOIN SECURITY_REFERENCE_HISTORY_BASE   tgt
    ON src.registered_entity_id = tgt.registered_entity_id
   AND src.effective_dt         = tgt.effective_dt
  WHERE src.md5_src <> src.md5_tgt
)
SELECT
  COUNT(*)                                                  AS total_mismatch_rows,
  SUM(CASE WHEN src_pub_reg_ent  <> tgt_pub_reg_ent THEN 1 ELSE 0 END) AS diff_registered_entity_id,
  SUM(CASE WHEN src_pub_bus_ent  <> tgt_pub_bus_ent THEN 1 ELSE 0 END)   AS diff_issuer_bus_ent_id,
  SUM(CASE WHEN src_bus_type     <> tgt_bus_type    THEN 1 ELSE 0 END)   AS diff_bus_ent_type_cd,
  SUM(CASE WHEN src_short_desc  <> tgt_short_desc  THEN 1 ELSE 0 END)    AS diff_short_desc,
  SUM(CASE WHEN src_long_desc   <> tgt_long_desc   THEN 1 ELSE 0 END)    AS diff_long_desc,
  SUM(CASE WHEN src_fmr_id      <> tgt_fmr_id      THEN 1 ELSE 0 END)    AS diff_fmr_id,
  SUM(CASE WHEN src_cusip       <> tgt_cusip       THEN 1 ELSE 0 END)    AS diff_cusip,
  SUM(CASE WHEN src_equity_cusip<> tgt_equity_cusip THEN 1 ELSE 0 END)    AS diff_equity_cusip,
  SUM(CASE WHEN src_equity_isin <> tgt_equity_isin  THEN 1 ELSE 0 END)    AS diff_equity_isin
FROM mismatches;




WITH sample AS (
  SELECT
    src.registered_entity_id,
    src.effective_dt,
    src.public_issuer_bus_ent_long_desc  AS src_long_desc_raw,
    tgt.public_issuer_bus_ent_long_desc  AS tgt_long_desc_raw
  FROM PUBLIC_ATTR_TRNS_SRH_ALTID_QDATA_ALT src
  JOIN SECURITY_REFERENCE_HISTORY_BASE   tgt
    ON src.registered_entity_id = tgt.registered_entity_id
   AND src.effective_dt         = tgt.effective_dt
  WHERE src.md5_src <> src.md5_tgt
    AND NVL(src.public_issuer_bus_ent_long_desc,'NA')
      <> NVL(tgt.public_issuer_bus_ent_long_desc,'NA')
  LIMIT 10
)
SELECT
  registered_entity_id,
  effective_dt,
  LENGTH(src_long_desc_raw) AS len_src,
  LENGTH(tgt_long_desc_raw) AS len_tgt,
  '['||src_long_desc_raw||']' AS src_bracketed,
  '['||tgt_long_desc_raw||']' AS tgt_bracketed
FROM sample;



