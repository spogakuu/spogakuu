SELECT
  srh.registered_entity_id,
  srh.effective_dt,
  srh.md5_src,
  srh.md5_tgt,

  -- old (prod) vs. new (incoming) columns
  hist.public_registered_entity_id   AS old_pub_reg_ent_id,
  srh.public_registered_entity_id    AS new_pub_reg_ent_id,
  hist.public_issuer_bus_ent_id      AS old_pub_bus_ent_id,
  srh.public_issuer_bus_ent_id       AS new_pub_bus_ent_id,
  hist.public_issuer_bus_ent_type_cd AS old_pub_bus_ent_type_cd,
  srh.public_issuer_bus_ent_type_cd  AS new_pub_bus_ent_type_cd,
  hist.public_issuer_bus_ent_short_desc AS old_pub_bus_ent_short_desc,
  srh.public_issuer_bus_ent_short_desc  AS new_pub_bus_ent_short_desc,
  hist.public_issuer_bus_ent_long_desc  AS old_pub_bus_ent_long_desc,
  srh.public_issuer_bus_ent_long_desc   AS new_pub_bus_ent_long_desc,
  hist.public_issuer_bus_ent_fmr_id     AS old_pub_bus_ent_fmr_id,
  srh.public_issuer_bus_ent_fmr_id      AS new_pub_bus_ent_fmr_id,
  hist.public_issuer_cusip              AS old_pub_issuer_cusip,
  srh.public_issuer_cusip               AS new_pub_issuer_cusip,
  hist.public_equity_cusip              AS old_pub_equity_cusip,
  srh.public_equity_cusip               AS new_pub_equity_cusip,
  hist.public_equity_isin               AS old_pub_equity_isin,
  srh.public_equity_isin                AS new_pub_equity_isin,

  -- build a pipe-separated list of changed fields
  CONCAT_WS('|',
    CASE WHEN NVL(srh.public_registered_entity_id, -1)
           <> NVL(hist.public_registered_entity_id, -1)
         THEN 'PUBLIC_REGISTERED_ENTITY_ID' END,
    CASE WHEN NVL(srh.public_issuer_bus_ent_id, -1)
           <> NVL(hist.public_issuer_bus_ent_id, -1)
         THEN 'PUBLIC_ISSUER_BUS_ENT_ID' END,
    CASE WHEN NVL(srh.public_issuer_bus_ent_type_cd, 'NA')
           <> NVL(hist.public_issuer_bus_ent_type_cd, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_TYPE_CD' END,
    CASE WHEN NVL(srh.public_issuer_bus_ent_short_desc, 'NA')
           <> NVL(hist.public_issuer_bus_ent_short_desc, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_SHORT_DESC' END,
    CASE WHEN NVL(srh.public_issuer_bus_ent_long_desc, 'NA')
           <> NVL(hist.public_issuer_bus_ent_long_desc, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_LONG_DESC' END,
    CASE WHEN NVL(srh.public_issuer_bus_ent_fmr_id, 'NA')
           <> NVL(hist.public_issuer_bus_ent_fmr_id, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_FMR_ID' END,
    CASE WHEN NVL(srh.public_issuer_cusip, 'NA')
           <> NVL(hist.public_issuer_cusip, 'NA')
         THEN 'PUBLIC_ISSUER_CUSIP' END,
    CASE WHEN NVL(srh.public_equity_cusip, 'NA')
           <> NVL(hist.public_equity_cusip, 'NA')
         THEN 'PUBLIC_EQUITY_CUSIP' END,
    CASE WHEN NVL(srh.public_equity_isin, 'NA')
           <> NVL(hist.public_equity_isin, 'NA')
         THEN 'PUBLIC_EQUITY_ISIN' END
  ) AS fields_changed

FROM PUBLIC_ATTR_TRNS_SRH_ALTID_QDATA_ALT AS srh
JOIN SECURITY_REFERENCE_HISTORY_BASE    AS hist
  ON srh.registered_entity_id = hist.registered_entity_id
 AND srh.effective_dt         = hist.effective_dt
WHERE srh.md5_src <> srh.md5_tgt
  AND CONCAT_WS('|',
        CASE WHEN NVL(srh.public_registered_entity_id, -1)
               <> NVL(hist.public_registered_entity_id, -1)
             THEN 'A' END,
        CASE WHEN NVL(srh.public_issuer_bus_ent_id, -1)
               <> NVL(hist.public_issuer_bus_ent_id, -1)
             THEN 'A' END,
        CASE WHEN NVL(srh.public_issuer_bus_ent_type_cd, 'NA')
               <> NVL(hist.public_issuer_bus_ent_type_cd, 'NA')
             THEN 'A' END,
        CASE WHEN NVL(srh.public_issuer_bus_ent_short_desc, 'NA')
               <> NVL(hist.public_issuer_bus_ent_short_desc, 'NA')
             THEN 'A' END,
        CASE WHEN NVL(srh.public_issuer_bus_ent_long_desc, 'NA')
               <> NVL(hist.public_issuer_bus_ent_long_desc, 'NA')
             THEN 'A' END,
        CASE WHEN NVL(srh.public_issuer_bus_ent_fmr_id, 'NA')
               <> NVL(hist.public_issuer_bus_ent_fmr_id, 'NA')
             THEN 'A' END,
        CASE WHEN NVL(srh.public_issuer_cusip, 'NA')
               <> NVL(hist.public_issuer_cusip, 'NA')
             THEN 'A' END,
        CASE WHEN NVL(srh.public_equity_cusip, 'NA')
               <> NVL(hist.public_equity_cusip, 'NA')
             THEN 'A' END,
        CASE WHEN NVL(srh.public_equity_isin, 'NA')
               <> NVL(hist.public_equity_isin, 'NA')
             THEN 'A' END
      ) <> ''  -- ensure at least one field differs
ORDER BY srh.registered_entity_id, srh.effective_dt;
