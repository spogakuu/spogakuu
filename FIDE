-- Step 1: Identify procedures that reference the am_dl_raw_amwh database
CREATE OR REPLACE TEMP TABLE matched_procedures AS
SELECT 
    procedure_catalog,
    procedure_schema,
    procedure_name,
    procedure_definition
FROM snowflake.account_usage.procedures
WHERE deleted IS NULL
  AND procedure_catalog = 'AM_DL_CUR_Q_QRI'
  AND procedure_schema IN ('QDATA', 'QMETA', 'OPERATIONS')
  AND procedure_definition ILIKE '%am_dl_raw_amwh.%';

-- Step 2: Extract raw reference strings from the procedure definition
CREATE OR REPLACE TEMP TABLE amwh_objects AS
SELECT 
    procedure_catalog,
    procedure_schema,
    procedure_name,
    TRIM(SUBSTRING(procedure_definition, 
        POSITION('am_dl_raw_amwh.' IN procedure_definition), 
        150)) AS raw_ref
FROM matched_procedures;

-- Step 3: Clean the object references (remove trailing characters)
CREATE OR REPLACE TEMP TABLE final_references AS
SELECT DISTINCT
    procedure_catalog,
    procedure_schema,
    procedure_name,
    CASE 
        WHEN POSITION(' ' IN raw_ref) > 0 THEN 
            LEFT(raw_ref, POSITION(' ' IN raw_ref) - 1)
        WHEN POSITION(';' IN raw_ref) > 0 THEN 
            LEFT(raw_ref, POSITION(';' IN raw_ref) - 1)
        WHEN POSITION(')' IN raw_ref) > 0 THEN 
            LEFT(raw_ref, POSITION(')' IN raw_ref) - 1)
        ELSE raw_ref
    END AS referenced_object
FROM amwh_objects
WHERE raw_ref ILIKE 'am_dl_raw_amwh.%';

-- Step 4: View results
SELECT * FROM final_references;
