CREATE OR REPLACE TABLE PUBLIC_ATTR_SRH_AUDIT AS

WITH diffs AS (
  SELECT
    alt.registered_entity_id,
    alt.effective_dt,
    alt.md5_src         AS incoming_md5,
    prod.md5_tgt        AS prod_md5,

    -- old vs. new values
    prod.public_registered_entity_id    AS old_pub_reg_ent_id,
    alt.public_registered_entity_id     AS new_pub_reg_ent_id,
    prod.public_issuer_bus_ent_id       AS old_pub_bus_ent_id,
    alt.public_issuer_bus_ent_id        AS new_pub_bus_ent_id,
    prod.public_issuer_bus_ent_type_cd  AS old_pub_bus_ent_type_cd,
    alt.public_issuer_bus_ent_type_cd   AS new_pub_bus_ent_type_cd,
    prod.public_issuer_bus_ent_short_desc AS old_pub_bus_ent_short_desc,
    alt.public_issuer_bus_ent_short_desc  AS new_pub_bus_ent_short_desc,
    prod.public_issuer_bus_ent_long_desc  AS old_pub_bus_ent_long_desc,
    alt.public_issuer_bus_ent_long_desc   AS new_pub_bus_ent_long_desc,
    prod.public_issuer_bus_ent_fmr_id     AS old_pub_bus_ent_fmr_id,
    alt.public_issuer_bus_ent_fmr_id      AS new_pub_bus_ent_fmr_id,
    prod.public_issuer_cusip              AS old_pub_issuer_cusip,
    alt.public_issuer_cusip               AS new_pub_issuer_cusip,
    prod.public_equity_cusip              AS old_pub_equity_cusip,
    alt.public_equity_cusip               AS new_pub_equity_cusip,
    prod.public_equity_isin               AS old_pub_equity_isin,
    alt.public_equity_isin                AS new_pub_equity_isin,

    -- vendor flags
    alt.is_kmk,
    alt.is_sdl,
    alt.is_isin,
    alt.is_cusip,

    -- build an array of changed fields
    SPLIT(
      CONCAT_WS('|',
        CASE WHEN NVL(alt.public_registered_entity_id,   -1) <> NVL(prod.public_registered_entity_id,   -1)
             THEN 'PUBLIC_REGISTERED_ENTITY_ID' END,
        CASE WHEN NVL(alt.public_issuer_bus_ent_id,      -1) <> NVL(prod.public_issuer_bus_ent_id,      -1)
             THEN 'PUBLIC_ISSUER_BUS_ENT_ID' END,
        CASE WHEN NVL(alt.public_issuer_bus_ent_type_cd, 'NA') <> NVL(prod.public_issuer_bus_ent_type_cd, 'NA')
             THEN 'PUBLIC_ISSUER_BUS_ENT_TYPE_CD' END,
        CASE WHEN NVL(alt.public_issuer_bus_ent_short_desc,'NA') <> NVL(prod.public_issuer_bus_ent_short_desc,'NA')
             THEN 'PUBLIC_ISSUER_BUS_ENT_SHORT_DESC' END,
        CASE WHEN NVL(alt.public_issuer_bus_ent_long_desc, 'NA') <> NVL(prod.public_issuer_bus_ent_long_desc, 'NA')
             THEN 'PUBLIC_ISSUER_BUS_ENT_LONG_DESC' END,
        CASE WHEN NVL(alt.public_issuer_bus_ent_fmr_id,   'NA') <> NVL(prod.public_issuer_bus_ent_fmr_id,   'NA')
             THEN 'PUBLIC_ISSUER_BUS_ENT_FMR_ID' END,
        CASE WHEN NVL(alt.public_issuer_cusip,            'NA') <> NVL(prod.public_issuer_cusip,            'NA')
             THEN 'PUBLIC_ISSUER_CUSIP' END,
        CASE WHEN NVL(alt.public_equity_cusip,            'NA') <> NVL(prod.public_equity_cusip,            'NA')
             THEN 'PUBLIC_EQUITY_CUSIP' END,
        CASE WHEN NVL(alt.public_equity_isin,             'NA') <> NVL(prod.public_equity_isin,             'NA')
             THEN 'PUBLIC_EQUITY_ISIN' END
      )
    ) AS changed_fields_array

  FROM PUBLIC_ATTR_TRNS_SRH_ALTID_QDATA_ALT alt
  JOIN SECURITY_REFERENCE_HISTORY_BASE     prod
    ON alt.registered_entity_id = prod.registered_entity_id
   AND alt.effective_dt         = prod.effective_dt
  WHERE alt.md5_src <> prod.md5_tgt
)

SELECT
  registered_entity_id,
  effective_dt,
  incoming_md5,
  prod_md5,

  old_pub_reg_ent_id, new_pub_reg_ent_id,
  old_pub_bus_ent_id, new_pub_bus_ent_id,
  old_pub_bus_ent_type_cd, new_pub_bus_ent_type_cd,
  old_pub_bus_ent_short_desc, new_pub_bus_ent_short_desc,
  old_pub_bus_ent_long_desc, new_pub_bus_ent_long_desc,
  old_pub_bus_ent_fmr_id, new_pub_bus_ent_fmr_id,
  old_pub_issuer_cusip, new_pub_issuer_cusip,
  old_pub_equity_cusip, new_pub_equity_cusip,
  old_pub_equity_isin, new_pub_equity_isin,

  -- truly meaningful change category
  CASE
    WHEN is_kmk   AND ARRAY_SIZE(changed_fields_array)>0 THEN 'Updated due to KMK changes'
    WHEN is_sdl   AND ARRAY_SIZE(changed_fields_array)>0 THEN 'Updated due to SDL changes'
    WHEN is_isin  AND ARRAY_SIZE(changed_fields_array)>0 THEN 'Updated due to ISIN changes'
    WHEN is_cusip AND ARRAY_SIZE(changed_fields_array)>0 THEN 'Updated due to CUSIP changes'
    WHEN ARRAY_SIZE(changed_fields_array)=1 
      THEN 'Updated due to ' || changed_fields_array[0]
    ELSE 'Updated due to multiple attribute changes'
  END AS change_category,

  -- detailed list of changed fields
  ARRAY_TO_STRING(changed_fields_array, '|') AS fields_changed

FROM diffs
ORDER BY registered_entity_id, effective_dt;
