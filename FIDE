WITH audit AS (
  SELECT
    src.registered_entity_id,
    src.effective_dt,

    src.md5_src,
    src.md5_tgt,

    -- compute fields_changed exactly as in your main query
    CONCAT_WS('|',
      CASE WHEN NVL(src.public_registered_entity_id, -1)
             <> NVL(tgt.public_registered_entity_id, -1) THEN 'PUBLIC_REGISTERED_ENTITY_ID' END,
      CASE WHEN NVL(src.public_issuer_bus_ent_id, -1)
             <> NVL(tgt.public_issuer_bus_ent_id, -1) THEN 'PUBLIC_ISSUER_BUS_ENT_ID' END,
      CASE WHEN NVL(src.public_issuer_bus_ent_type_cd, 'NA')
             <> NVL(tgt.public_issuer_bus_ent_type_cd, 'NA') THEN 'PUBLIC_ISSUER_BUS_ENT_TYPE_CD' END,
      CASE WHEN NVL(src.public_issuer_bus_ent_short_desc, 'NA')
             <> NVL(tgt.public_issuer_bus_ent_short_desc, 'NA') THEN 'PUBLIC_ISSUER_BUS_ENT_SHORT_DESC' END,
      CASE WHEN NVL(src.public_issuer_bus_ent_long_desc, 'NA')
             <> NVL(tgt.public_issuer_bus_ent_long_desc, 'NA') THEN 'PUBLIC_ISSUER_BUS_ENT_LONG_DESC' END,
      CASE WHEN NVL(src.public_issuer_bus_ent_fmr_id, 'NA')
             <> NVL(tgt.public_issuer_bus_ent_fmr_id, 'NA') THEN 'PUBLIC_ISSUER_BUS_ENT_FMR_ID' END,
      CASE WHEN NVL(src.public_issuer_cusip, 'NA')
             <> NVL(tgt.public_issuer_cusip, 'NA') THEN 'PUBLIC_ISSUER_CUSIP' END,
      CASE WHEN NVL(src.public_equity_cusip, 'NA')
             <> NVL(tgt.public_equity_cusip, 'NA') THEN 'PUBLIC_EQUITY_CUSIP' END,
      CASE WHEN NVL(src.public_equity_isin, 'NA')
             <> NVL(tgt.public_equity_isin, 'NA') THEN 'PUBLIC_EQUITY_ISIN' END
    ) AS fields_changed

  FROM PUBLIC_ATTR_TRNS_SRH_ALTID_QDATA_ALT AS src
  JOIN SECURITY_REFERENCE_HISTORY_BASE     AS tgt
    ON src.registered_entity_id = tgt.registered_entity_id
   AND src.effective_dt         = tgt.effective_dt
  WHERE src.md5_src <> src.md5_tgt
)
SELECT
  COUNT(*)                               AS total_md5_mismatch,
  SUM(CASE WHEN fields_changed = '' THEN 1 ELSE 0 END) AS no_fieldtags,
  SUM(CASE WHEN fields_changed <> '' THEN 1 ELSE 0 END) AS with_fieldtags
FROM audit;
