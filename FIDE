SELECT
  alt.registered_entity_id,
  alt.effective_dt,
  alt.md5_src       AS incoming_md5,
  prod.md5_tgt      AS prod_md5,

  -- build a pipe-delimited list of exactly which audited columns differ
  CONCAT_WS('|',
    CASE WHEN NVL(alt.public_registered_entity_id, -1)
           <> NVL(prod.public_registered_entity_id, -1)
         THEN 'PUBLIC_REGISTERED_ENTITY_ID' END,
    CASE WHEN NVL(alt.public_issuer_bus_ent_id, -1)
           <> NVL(prod.public_issuer_bus_ent_id, -1)
         THEN 'PUBLIC_ISSUER_BUS_ENT_ID' END,
    CASE WHEN NVL(alt.public_issuer_bus_ent_type_cd, 'NA')
           <> NVL(prod.public_issuer_bus_ent_type_cd, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_TYPE_CD' END,
    CASE WHEN NVL(alt.public_issuer_bus_ent_short_desc, 'NA')
           <> NVL(prod.public_issuer_bus_ent_short_desc, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_SHORT_DESC' END,
    CASE WHEN NVL(alt.public_issuer_bus_ent_long_desc, 'NA')
           <> NVL(prod.public_issuer_bus_ent_long_desc, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_LONG_DESC' END,
    CASE WHEN NVL(alt.public_issuer_bus_ent_fmr_id, 'NA')
           <> NVL(prod.public_issuer_bus_ent_fmr_id, 'NA')
         THEN 'PUBLIC_ISSUER_BUS_ENT_FMR_ID' END,
    CASE WHEN NVL(alt.public_issuer_cusip, 'NA')
           <> NVL(prod.public_issuer_cusip, 'NA')
         THEN 'PUBLIC_ISSUER_CUSIP' END,
    CASE WHEN NVL(alt.public_equity_cusip, 'NA')
           <> NVL(prod.public_equity_cusip, 'NA')
         THEN 'PUBLIC_EQUITY_CUSIP' END,
    CASE WHEN NVL(alt.public_equity_isin, 'NA')
           <> NVL(prod.public_equity_isin, 'NA')
         THEN 'PUBLIC_EQUITY_ISIN' END
  ) AS fields_changed

FROM PUBLIC_ATTR_TRNS_SRH_ALTID_QDATA_ALT alt
JOIN PRODUCTION.SECURITY_REFERENCE_HISTORY_BASE prod
  ON alt.registered_entity_id = prod.registered_entity_id
 AND alt.effective_dt         = prod.effective_dt
WHERE alt.md5_src <> prod.md5_tgt
  AND CONCAT_WS('|',
      CASE WHEN NVL(alt.public_registered_entity_id, -1)
             <> NVL(prod.public_registered_entity_id, -1) THEN 'X' END,
      CASE WHEN NVL(alt.public_issuer_bus_ent_id, -1)
             <> NVL(prod.public_issuer_bus_ent_id, -1) THEN 'X' END,
      CASE WHEN NVL(alt.public_issuer_bus_ent_type_cd, 'NA')
             <> NVL(prod.public_issuer_bus_ent_type_cd, 'NA') THEN 'X' END,
      CASE WHEN NVL(alt.public_issuer_bus_ent_short_desc, 'NA')
             <> NVL(prod.public_issuer_bus_ent_short_desc, 'NA') THEN 'X' END,
      CASE WHEN NVL(alt.public_issuer_bus_ent_long_desc, 'NA')
             <> NVL(prod.public_issuer_bus_ent_long_desc, 'NA') THEN 'X' END,
      CASE WHEN NVL(alt.public_issuer_bus_ent_fmr_id, 'NA')
             <> NVL(prod.public_issuer_bus_ent_fmr_id, 'NA') THEN 'X' END,
      CASE WHEN NVL(alt.public_issuer_cusip, 'NA')
             <> NVL(prod.public_issuer_cusip, 'NA') THEN 'X' END,
      CASE WHEN NVL(alt.public_equity_cusip, 'NA')
             <> NVL(prod.public_equity_cusip, 'NA') THEN 'X' END,
      CASE WHEN NVL(alt.public_equity_isin, 'NA')
             <> NVL(prod.public_equity_isin, 'NA') THEN 'X' END
    ) <> ''
ORDER BY alt.registered_entity_id, alt.effective_dt
LIMIT 20;
